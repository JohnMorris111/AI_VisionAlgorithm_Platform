<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>AIè¿åœæ£€æµ‹ - æœ€å°ç¤ºä¾‹</title>
</head>

<body>
    <h1>AIè¿åœæ£€æµ‹</h1>
    <p>æŒ‰ <code>F12</code> (Windows) æˆ– <code>Cmd+Option+I</code> (Mac) æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹æ£€æµ‹ç»“æœ</p>
    <button id="start">å¯åŠ¨</button>
    <button id="stop">åœæ­¢</button>
    <br><br>
    <img id="video" style="max-width:640px;">

    <script>
        // å»ºç«‹è¿æ¥ï¼šæ‹‰å¼€é€šä¿¡çš„â€œé—¸é—¨â€
        const ws = new WebSocket('ws://127.0.0.1:8000/ws');
        const img = document.getElementById('video');
        let stopResolver = null;

        ws.onopen = function () {
            console.log('âœ… å·²è¿æ¥');
        };

        // ã€æ”¶ã€‘æ ¸å¿ƒç›‘å¬å™¨ï¼šåªè¦æœåŠ¡å™¨å¾€å‰ç«¯â€œæ¨â€æ•°æ®ï¼Œè¿™ä¸ªå‡½æ•°å°±ä¼šè¢«è‡ªåŠ¨è§¦å‘
        // å‚æ•° eï¼šå³ MessageEvent æ¶ˆæ¯å¯¹è±¡ï¼Œå®ƒæ˜¯æœåŠ¡å™¨å‘è¿‡æ¥çš„â€œä¿¡å°â€
        ws.onmessage = async function (e) {

            // e.dataï¼šä¿¡å°é‡Œçš„â€œä¿¡ä»¶å†…å®¹â€ï¼Œå¯èƒ½æ˜¯äºŒè¿›åˆ¶å›¾ï¼Œä¹Ÿå¯èƒ½æ˜¯ JSON å­—ç¬¦ä¸²

            // æ¨¡å¼ Aï¼šå¦‚æœæ”¶åˆ°çš„æ˜¯äºŒè¿›åˆ¶æ•°æ® (Blob)ï¼Œè¯´æ˜æœåŠ¡å™¨æ¨è¿‡æ¥çš„æ˜¯è§†é¢‘å¸§
            if (e.data instanceof Blob) {
                img.src = URL.createObjectURL(e.data); // æŠŠäºŒè¿›åˆ¶å›¾è½¬ä¸º URL æ˜¾ç¤ºå‡ºæ¥
                return;
            }

            // æ¨¡å¼ Bï¼šå¦‚æœæ”¶åˆ°çš„æ˜¯å­—ç¬¦ä¸²ï¼Œé€šè¿‡ JSON è§£æè¯»å–å…·ä½“å­—æ®µ
            const data = JSON.parse(e.data);

            if (data.type === 'payload') {
                const payload = data.payload || data.data || {};
                // å®æ—¶æ‰“å°æœåŠ¡å™¨æ¨è¿‡æ¥çš„â€œç®—æ³•ç»“æœâ€
                console.log('ğŸ“Š [æ”¶] æœåŠ¡å™¨æ¨é€ç»“æœ (Payload):', JSON.stringify(payload, null, 2));
                const tracks = payload.tracks || {};
                for (const [id, info] of Object.entries(tracks)) {
                    const areaName = info.parking_area?.area_name || 'æœªå‘½ä¸­åœè½¦åŒºåŸŸ';
                    console.log('ğŸš— è½¦è¾† ' + id + ': ' + (info.status || 'åœè½¦') + ' | åŒºåŸŸ: ' + areaName);
                }
            } else if (data.type === 'frame') {
                // console.log('ğŸ“¹ è§†é¢‘å¸§æ—¶é—´æˆ³: ' + data.ts);
            } else if (data.type === 'error') {
                console.error('âŒ é”™è¯¯:', data.error);
            } else if (data.type === 'stopped') {
                console.log('â¹ï¸ æ£€æµ‹å·²åœæ­¢');
                // å¦‚æœæœ‰åœ¨ç­‰å¾… stop çš„ Promiseï¼Œåˆ™è§¦å‘ resolve
                if (stopResolver) {
                    stopResolver();
                    stopResolver = null;
                }
            } else if (data.type === 'started') {
                console.log('ğŸš€ æ£€æµ‹å·²å¯åŠ¨: ' + (data.algorithm || 'unknown'));
            }
        };

        // å¯åŠ¨æŒ‰é’®é€»è¾‘
        document.getElementById('start').onclick = async function () {
            console.log('â³ æ­£åœ¨é‡ç½®æ£€æµ‹æµ...');

            // ã€å‘ã€‘ä¸»åŠ¨ç»™æœåŠ¡å™¨æ¨æŒ‡ä»¤ï¼šè¦æ±‚åœæ­¢
            ws.send(JSON.stringify({ type: 'stop' }));

            // ç­‰å¾…åœæ­¢ç¡®è®¤
            await new Promise(function (resolve) {
                stopResolver = resolve;
                setTimeout(function () {
                    if (stopResolver) {
                        console.warn('âš ï¸ åœæ­¢å“åº”è¶…æ—¶');
                        stopResolver = null;
                        resolve();
                    }
                }, 2000);
            });

            // ã€å‘ã€‘ä¸»åŠ¨ç»™æœåŠ¡å™¨æ¨æŒ‡ä»¤ï¼šè¦æ±‚å¯åŠ¨æ£€æµ‹
            // æ­¤æ—¶æœåŠ¡å™¨æ¥åˆ°å‘½ä»¤ï¼Œå°±ä¼šå¼€å§‹æºæºä¸æ–­åœ°ç”¨ onmessage é‡Œçš„é€»è¾‘ç»™ä½ æ¨æ•°æ®
            ws.send(JSON.stringify({
                type: 'start',
                source: '/Volumes/John/yolov8-visdrone/aiparking125Beta2RoiAiRepot/source/è½¦è¾†è¿åœ.mp4'
            }));
            console.log('â–¶ï¸ [å‘] å·²å‘é€å¯åŠ¨å‘½ä»¤');
        };

        document.getElementById('stop').onclick = function () {
            // ã€å‘ã€‘æ¨æŒ‡ä»¤
            ws.send(JSON.stringify({ type: 'stop' }));
        };
    </script>
</body>

</html>
