<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIæ¥å£æ–‡æ¡£ (è¿åœæ£€æµ‹) - ä½ç©ºAIè§†è§‰ç®—æ³•å¹³å°</title>
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.1/github-markdown-light.min.css">
    <style>
        body {
            box-sizing: border-box;
            max-width: 900px;
            margin: 0 auto;
            padding: 45px;
            background: #fff;
        }

        .markdown-body h1 {
            border-bottom: 1px solid #d1d9e0;
            padding-bottom: 0.3em;
        }

        .markdown-body h2 {
            border-bottom: 1px solid #d1d9e0;
            padding-bottom: 0.3em;
            margin-top: 32px;
        }

        .breadcrumb {
            margin-bottom: 16px;
            font-size: 14px;
        }

        .breadcrumb a {
            color: #0969da;
            text-decoration: none;
        }

        /* é€‰é¡¹å¡ */
        .tabs {
            display: flex;
            border-bottom: 1px solid #d1d9e0;
            margin: 24px 0 0 0;
        }

        .tab-btn {
            padding: 12px 24px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #656d76;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
        }

        .tab-btn.active {
            color: #0969da;
            border-bottom-color: #fd8c73;
        }

        .tab-btn:hover {
            color: #0969da;
        }

        .tab-content {
            display: none;
            padding: 24px 0;
        }

        .tab-content.active {
            display: block;
        }

        pre {
            background: #f6f8fa;
            border-radius: 6px;
            padding: 16px;
            overflow: auto;
            font-size: 13px;
        }

        code {
            background: rgba(175, 184, 193, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 85%;
        }

        pre code {
            background: none;
            padding: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
        }

        th,
        td {
            border: 1px solid #d1d9e0;
            padding: 10px 16px;
            text-align: left;
        }

        th {
            background: #f6f8fa;
        }

        .tip {
            padding: 12px 16px;
            border-radius: 6px;
            margin: 16px 0;
            background: #ddf4ff;
            border-left: 4px solid #0969da;
            font-size: 14px;
        }

        .footer {
            margin-top: 48px;
            padding-top: 24px;
            border-top: 1px solid #d1d9e0;
            color: #656d76;
            font-size: 14px;
        }
    </style>
</head>

<body class="markdown-body">

    <div class="breadcrumb">
        <a href="../../index.html">å¹³å°é¦–é¡µ</a> / <a href="index.html">AIè¿åœæ£€æµ‹</a> / APIæ–‡æ¡£
    </div>

    <h1>ğŸ“– API æ¥å£æ–‡æ¡£</h1>
    <p>WebSocket å®æ—¶é€šä¿¡æ¥å£ï¼Œæ”¯æŒ Python åç«¯å’Œå‰ç«¯ JavaScript ä¸¤ç§æ¥å…¥æ–¹å¼ã€‚</p>

    <h2>ğŸ”Œ æ¥å£åœ°å€</h2>
    <pre><code>ws://æœåŠ¡å™¨IP:8000/ws_roi</code></pre>

    <h2>ğŸ“¨ æ¶ˆæ¯æ ¼å¼</h2>

    <table>
        <tr>
            <th>æ–¹å‘</th>
            <th>æ¶ˆæ¯ç±»å‹</th>
            <th>æ ¼å¼</th>
            <th>è¯´æ˜</th>
        </tr>
        <tr>
            <td>å‘é€</td>
            <td><code>start</code></td>
            <td>JSON</td>
            <td>å¯åŠ¨æ£€æµ‹</td>
        </tr>
        <tr>
            <td>å‘é€</td>
            <td><code>stop</code></td>
            <td>JSON</td>
            <td>åœæ­¢æ£€æµ‹</td>
        </tr>
        <tr>
            <td>æ¥æ”¶</td>
            <td><code>payload</code></td>
            <td>JSON</td>
            <td>æ£€æµ‹ç»“æœæ•°æ®</td>
        </tr>
        <tr>
            <td>æ¥æ”¶</td>
            <td><code>frame</code></td>
            <td>JSON + äºŒè¿›åˆ¶</td>
            <td>å¸¦æ ‡æ³¨çš„è§†é¢‘å¸§ï¼ˆJPEGï¼‰</td>
        </tr>
        <tr>
            <td>æ¥æ”¶</td>
            <td><code>error</code></td>
            <td>JSON</td>
            <td>é”™è¯¯ä¿¡æ¯</td>
        </tr>
        <tr>
            <td>æ¥æ”¶</td>
            <td><code>stopped</code></td>
            <td>JSON</td>
            <td>å·²åœæ­¢</td>
        </tr>
    </table>

    <div class="tip">
        ğŸ“¹ <strong>è§†é¢‘å¸§è¯´æ˜ï¼š</strong> <code>frame</code> æ¶ˆæ¯åç´§è·Ÿä¸€æ¡<strong>äºŒè¿›åˆ¶æ¶ˆæ¯</strong>ï¼Œå†…å®¹ä¸º JPEG æ ¼å¼çš„æ ‡æ³¨å¸§å›¾ç‰‡ã€‚
    </div>

    <h2>ğŸš€ æ¥å…¥ç¤ºä¾‹</h2>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('python')">ğŸ Python æ¥å…¥</button>
        <button class="tab-btn" onclick="switchTab('frontend')">ğŸŒ å‰ç«¯æ¥å…¥</button>
    </div>

    <!-- Python æ¥å…¥ -->
    <div id="tab-python" class="tab-content active">
        <h3>å®‰è£…ä¾èµ–</h3>
        <pre><code>pip install websockets opencv-python numpy</code></pre>

        <h3>å®Œæ•´ç¤ºä¾‹</h3>
        <pre><code>import asyncio
import websockets
import json
import cv2
import numpy as np

async def main():
    uri = "ws://127.0.0.1:8000/ws_roi"
    
    async with websockets.connect(uri) as ws:
        # 1. åœæ­¢ä¹‹å‰çš„æµ (å¯é€‰ï¼Œåç«¯ä¼šè‡ªåŠ¨å¤„ç†ï¼Œä½†æ˜¾å¼è°ƒç”¨æ›´å®‰å…¨)
        await ws.send(json.dumps({"type": "stop"}))
        
        # 2. å¯åŠ¨æ£€æµ‹
        await ws.send(json.dumps({
            "type": "start",
            "source": "rtsp://your-camera/stream" # æˆ–æœ¬åœ°æ–‡ä»¶è·¯å¾„
        }))
        
        # 3. æ¥æ”¶ loop
        while True:
            try:
                msg = await ws.recv()
            except websockets.exceptions.ConnectionClosed:
                break
            
            # äºŒè¿›åˆ¶æ¶ˆæ¯ = è§†é¢‘å¸§ (JPEG)
            if isinstance(msg, bytes):
                frame = cv2.imdecode(np.frombuffer(msg, np.uint8), cv2.IMREAD_COLOR)
                if frame is not None:
                    cv2.imshow("Preview", frame)
                    if cv2.waitKey(1) & 0xFF == ord('q'): break
                continue
            
            # JSON æ¶ˆæ¯
            try:
                data = json.loads(msg)
            except json.JSONDecodeError:
                continue
            
            if data.get("type") == "payload":
                # å¤„ç†æ£€æµ‹ç»“æœ
                print(f"Frame {data['payload']['frame_index']}: {len(data['payload']['tracks'])} objects")
                
            elif data.get("type") == "error":
                print(f"Error: {data.get('message') or data.get('error')}")
                break
                
            elif data.get("type") == "stop":
                print("Stopped")
                break

    cv2.destroyAllWindows()

asyncio.run(main())</code></pre>
    </div>

    <!-- å‰ç«¯æ¥å…¥ -->
    <div id="tab-frontend" class="tab-content">
        <h3>æœ€å°ç¤ºä¾‹ï¼ˆæ— æ¸²æŸ“ï¼‰</h3>
        <p>å¤åˆ¶ä»¥ä¸‹ä»£ç ä¿å­˜ä¸º HTML æ–‡ä»¶å³å¯è¿è¡Œï¼Œæ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹è¾“å‡ºï¼š</p>

        <pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;body&gt;
  &lt;h1&gt;AIè¿åœæ£€æµ‹&lt;/h1&gt;
  &lt;img id="video" style="max-width:640px;"&gt;
  &lt;div&gt;
      &lt;button id="start"&gt;Start&lt;/button&gt;
      &lt;button id="stop"&gt;Stop&lt;/button&gt;
  &lt;/div&gt;

  &lt;script&gt;
    const ws = new WebSocket('ws://127.0.0.1:8000/ws_roi');
    const img = document.getElementById('video');
    
    ws.onmessage = (e) =&gt; {
      // 1. å¤„ç†äºŒè¿›åˆ¶è§†é¢‘å¸§ (Blob)
      if (e.data instanceof Blob) {
        img.src = URL.createObjectURL(e.data);
      } else {
        // 2. å¤„ç† JSON æ•°æ®æ¶ˆæ¯
        const data = JSON.parse(e.data);
        if (data.type === 'payload') console.log('æ£€æµ‹ç»“æœ:', data.payload);
        else if (data.type === 'error') console.error('é”™è¯¯:', data.message);
      }
    };
    
    document.getElementById('start').onclick = () =&gt; {
      // å‘é€å¯åŠ¨æŒ‡ä»¤ (æ”¯æŒ RTSP æˆ– æ–‡ä»¶è·¯å¾„)
      ws.send(JSON.stringify({ type: 'start', source: 'rtsp://...' }));
    };
    
    document.getElementById('stop').onclick = () =&gt; {
      ws.send(JSON.stringify({ type: 'stop' }));
    };
  &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
        <div class="tip">
            ğŸ’¡ <strong>æç¤ºï¼š</strong> å¦‚éœ€å¸¦ UI æ¸²æŸ“çš„å®Œæ•´ç¤ºä¾‹ï¼Œè¯·æŸ¥çœ‹ <a href="demo.html">åœ¨çº¿æ¼”ç¤º</a>
        </div>
    </div>

    <h2>ğŸ“¤ å‘é€æ¶ˆæ¯</h2>

    <h3>å¯åŠ¨æ£€æµ‹</h3>
    <pre><code>{
  "type": "start",
  "source": "rtsp://user:pass@192.168.1.100:554/stream"
}</code></pre>

    <table>
        <tr>
            <th>å­—æ®µ</th>
            <th>ç±»å‹</th>
            <th>å¿…å¡«</th>
            <th>è¯´æ˜</th>
        </tr>
        <tr>
            <td><code>type</code></td>
            <td>string</td>
            <td>âœ…</td>
            <td>å›ºå®šå€¼ <code>"start"</code></td>
        </tr>
        <tr>
            <td><code>source</code></td>
            <td>string</td>
            <td>âœ…</td>
            <td>è§†é¢‘æºåœ°å€ï¼ˆRTSP/HTTP/æœ¬åœ°è·¯å¾„ï¼‰</td>
        </tr>
    </table>

    <h3>åœæ­¢æ£€æµ‹</h3>
    <pre><code>{"type": "stop"}</code></pre>

    <h2>ğŸ“¥ æ¥æ”¶æ¶ˆæ¯</h2>

    <h3>æ£€æµ‹ç»“æœ</h3>
    <pre><code>{
  "type": "payload",
  "payload": {
    "frame_index": 1234,
    "tracks": {
      "1": {
        "track_id": 1,
        "class_name": "å°æ±½è½¦",
        "bbox": [100, 200, 300, 400],
        "parked_frames": 45,
        "panduan": "è¿è§„åœè½¦",
        "parking_area": {
          "area_id": "wrong_1",
          "area_name": "æ¶ˆé˜²é€šé“A",
          "area_type": "forbidden",
          "inside": true,
          "overlap_ratio": 0.91
        },
        "status": "è¿è§„åœè½¦"
      }
    },
    "areas": {
      "legal": [
        {"area_id": "right_1", "name": "ä¸´æ—¶åœè½¦ä½", "bbox": [80, 180, 360, 460]}
      ],
      "forbidden": [
        {"area_id": "wrong_1", "name": "æ¶ˆé˜²é€šé“A", "bbox": [60, 160, 400, 500]}
      ]
    }
  }
}</code></pre>

    <table>
        <tr>
            <th>å­—æ®µ</th>
            <th>è¯´æ˜</th>
        </tr>
        <tr>
            <td><code>frame_index</code></td>
            <td>å½“å‰å¸§åºå·</td>
        </tr>
        <tr>
            <td><code>tracks</code></td>
            <td>è½¦è¾†è¿½è¸ªä¿¡æ¯ï¼ˆkey ä¸ºè½¦è¾†IDï¼‰</td>
        </tr>
        <tr>
            <td><code>areas</code></td>
            <td>åœè½¦åŒºåŸŸå®šä¹‰ï¼ˆåˆæ³•åŒº/ç¦åœåŒºï¼‰</td>
        </tr>
        <tr>
            <td><code>track_id</code></td>
            <td>è½¦è¾†è¿½è¸ªID</td>
        </tr>
        <tr>
            <td><code>class_name</code></td>
            <td>è½¦è¾†ç±»å‹ï¼ˆå°æ±½è½¦/é¢åŒ…è½¦/å¡è½¦ï¼‰</td>
        </tr>
        <tr>
            <td><code>bbox</code></td>
            <td>è¾¹ç•Œæ¡† [x1, y1, x2, y2]</td>
        </tr>
        <tr>
            <td><code>parked_frames</code></td>
            <td>ç´¯è®¡åœè½¦å¸§æ•°</td>
        </tr>
        <tr>
            <td><code>panduan</code></td>
            <td>äºŒé˜¶æ®µåŒºåŸŸåˆ¤å®šç»“æœï¼ˆåˆæ³•åœè½¦/è¿è§„åœè½¦ï¼‰</td>
        </tr>
        <tr>
            <td><code>parking_area</code></td>
            <td>è¯¥è½¦è¾†å‘½ä¸­çš„åœè½¦åŒºåŸŸä¿¡æ¯</td>
        </tr>
        <tr>
            <td><code>parking_area.area_id</code></td>
            <td>å‘½ä¸­åŒºåŸŸ IDï¼ˆä¸ <code>areas</code> å†…å®šä¹‰å¯¹åº”ï¼‰</td>
        </tr>
        <tr>
            <td><code>parking_area.area_type</code></td>
            <td>åŒºåŸŸç±»å‹ï¼ˆ<code>legal</code>/<code>forbidden</code>/<code>unknown</code>ï¼‰</td>
        </tr>
        <tr>
            <td><code>parking_area.overlap_ratio</code></td>
            <td>è½¦è¾†ä¸åœè½¦åŒºåŸŸé‡å æ¯”ä¾‹ï¼ˆ0-1ï¼‰</td>
        </tr>
        <tr>
            <td><code>status</code></td>
            <td>çŠ¶æ€ï¼ˆç§»åŠ¨/åœè½¦/åˆæ³•åœè½¦/è¿è§„åœè½¦ï¼‰</td>
        </tr>
    </table>

    <h2>ğŸ“Š AI è§†è§‰åˆ†æ</h2>

    <p>å½“æ£€æµ‹åˆ°è¿è§„åœè½¦äº‹ä»¶åï¼Œç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆå®Œæ•´çš„è¯æ®æŠ¥å‘Šï¼Œä¿å­˜åœ¨ <code>result/</code> ç›®å½•ï¼š</p>

    <pre><code>result/
â””â”€â”€ 20260126_005935_punish_id880/
    â”œâ”€â”€ id880_frame107_full.jpg      # å…¨æ™¯æˆªå›¾
    â”œâ”€â”€ id880_frame107_crop.jpg      # ç›®æ ‡è£å‰ªå›¾
    â”œâ”€â”€ id880_frame107_annotated.jpg # å¸¦æ ‡æ³¨æˆªå›¾
    â”œâ”€â”€ id880_frame107.csv           # ç»“æ„åŒ–æ•°æ®
    â”œâ”€â”€ report.html                  # å¯è§†åŒ–æŠ¥å‘Š
    â””â”€â”€ summary.json                 # AI åˆ†ææ‘˜è¦</code></pre>

    <h3>summary.json æ ¼å¼</h3>
    <pre><code>{
  "verdict": "REVIEW",           // åˆ¤å®š: ILLEGAL(è¿è§„) / LEGAL(åˆæ³•) / REVIEW(å¾…å¤æ ¸)
  "confidence": 0.85,            // ç½®ä¿¡åº¦ 0-1
  "car_id": 880,                 // è½¦è¾†è¿½è¸ªID
  "parked_frames": 45,           // åœè½¦å¸§æ•°
  "evidence_level": "HIGH",      // è¯æ®ç­‰çº§: HIGH/MEDIUM/LOW
  "summary": "è½¦è¾†åœäºé“è·¯å³ä¾§...", // AI åˆ†ææ€»ç»“
  "evidence": {                  // è¯æ®å›¾ç‰‡åˆ†æ
    "img1": ["åˆ†ææè¿°1", "åˆ†ææè¿°2"],
    "img2": ["åˆ†ææè¿°1"]
  },
  "missing_evidence": [...],     // ç¼ºå¤±è¯æ®
  "next_actions": [...]          // å»ºè®®åç»­æ“ä½œ
}</code></pre>

    <table>
        <tr>
            <th>å­—æ®µ</th>
            <th>è¯´æ˜</th>
        </tr>
        <tr>
            <td><code>verdict</code></td>
            <td>åˆ¤å®šç»“è®ºï¼ˆILLEGAL/LEGAL/REVIEWï¼‰</td>
        </tr>
        <tr>
            <td><code>confidence</code></td>
            <td>ç½®ä¿¡åº¦è¯„åˆ† 0-1</td>
        </tr>
        <tr>
            <td><code>summary</code></td>
            <td>AI ç”Ÿæˆçš„æ–‡å­—æ€»ç»“è¯´æ˜</td>
        </tr>
        <tr>
            <td><code>evidence</code></td>
            <td>å¯¹å„æˆªå›¾çš„é€æ¡åˆ†æ</td>
        </tr>
        <tr>
            <td><code>missing_evidence</code></td>
            <td>ç¼ºå¤±çš„å…³é”®è¯æ®</td>
        </tr>
        <tr>
            <td><code>next_actions</code></td>
            <td>å»ºè®®çš„åç»­æ“ä½œ</td>
        </tr>
    </table>

    <div class="footer">
        <p><a href="index.html">â† è¿”å›äº§å“é¡µ</a></p>
    </div>

    <script>
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
        }
    </script>

</body>

</html>
