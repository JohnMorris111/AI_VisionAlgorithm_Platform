<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIæ¥å£æ–‡æ¡£ - äº¤é€šæ‹¥æŒ¤è¯†åˆ«</title>
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.1/github-markdown-light.min.css">
    <style>
        body {
            box-sizing: border-box;
            max-width: 900px;
            margin: 0 auto;
            padding: 45px;
            background: #fff;
        }

        .markdown-body h1 {
            border-bottom: 1px solid #d1d9e0;
            padding-bottom: 0.3em;
        }

        .markdown-body h2 {
            border-bottom: 1px solid #d1d9e0;
            padding-bottom: 0.3em;
            margin-top: 32px;
        }

        .breadcrumb {
            margin-bottom: 16px;
            font-size: 14px;
        }

        .breadcrumb a {
            color: #0969da;
            text-decoration: none;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #d1d9e0;
            margin: 24px 0 0 0;
        }

        .tab-btn {
            padding: 12px 24px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #656d76;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
        }

        .tab-btn.active {
            color: #0969da;
            border-bottom-color: #fd8c73;
        }

        .tab-btn:hover {
            color: #0969da;
        }

        .tab-content {
            display: none;
            padding: 24px 0;
        }

        .tab-content.active {
            display: block;
        }

        pre {
            background: #f6f8fa;
            border-radius: 6px;
            padding: 16px;
            overflow: auto;
            font-size: 13px;
        }

        code {
            background: rgba(175, 184, 193, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 85%;
        }

        pre code {
            background: none;
            padding: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
        }

        th,
        td {
            border: 1px solid #d1d9e0;
            padding: 10px 16px;
            text-align: left;
        }

        th {
            background: #f6f8fa;
        }

        .tip {
            padding: 12px 16px;
            border-radius: 6px;
            margin: 16px 0;
            background: #ddf4ff;
            border-left: 4px solid #0969da;
            font-size: 14px;
        }

        .footer {
            margin-top: 48px;
            padding-top: 24px;
            border-top: 1px solid #d1d9e0;
            color: #656d76;
            font-size: 14px;
        }
    </style>
</head>

<body class="markdown-body">

    <div class="breadcrumb">
        <a href="../../index.html">å¹³å°é¦–é¡µ</a> / <a href="index.html">äº¤é€šæ‹¥æŒ¤è¯†åˆ«</a> / APIæ–‡æ¡£
    </div>

    <h1>ğŸ“– API æ¥å£æ–‡æ¡£</h1>
    <p>WebSocket å®æ—¶é€šä¿¡æ¥å£ï¼Œæ”¯æŒ Python åç«¯å’Œå‰ç«¯ JavaScript ä¸¤ç§æ¥å…¥æ–¹å¼ã€‚</p>

    <h2>ğŸ”Œ æ¥å£åœ°å€</h2>
    <pre><code>ws://æœåŠ¡å™¨IP:8000/ws</code></pre>

    <h2>ğŸ“¨ æ¶ˆæ¯æ ¼å¼</h2>

    <table>
        <tr>
            <th>æ–¹å‘</th>
            <th>æ¶ˆæ¯ç±»å‹</th>
            <th>æ ¼å¼</th>
            <th>è¯´æ˜</th>
        </tr>
        <tr>
            <td>å‘é€</td>
            <td><code>start</code></td>
            <td>JSON</td>
            <td>å¯åŠ¨æ£€æµ‹</td>
        </tr>
        <tr>
            <td>å‘é€</td>
            <td><code>stop</code></td>
            <td>JSON</td>
            <td>åœæ­¢æ£€æµ‹</td>
        </tr>
        <tr>
            <td>å‘é€</td>
            <td><code>status</code></td>
            <td>JSON</td>
            <td>æŸ¥è¯¢çŠ¶æ€</td>
        </tr>
        <tr>
            <td>æ¥æ”¶</td>
            <td><code>response</code></td>
            <td>JSON</td>
            <td>æŒ‡ä»¤å“åº”</td>
        </tr>
        <tr>
            <td>æ¥æ”¶</td>
            <td><code>frame</code></td>
            <td>JSON</td>
            <td>æ£€æµ‹ç»“æœ + æ ‡æ³¨å›¾ï¼ˆbase64ï¼‰</td>
        </tr>
        <tr>
            <td>æ¥æ”¶</td>
            <td><code>error</code></td>
            <td>JSON</td>
            <td>é”™è¯¯ä¿¡æ¯</td>
        </tr>
    </table>

    <div class="tip">
        ğŸ“· <strong>å›¾åƒè¯´æ˜ï¼š</strong> <code>frame</code> æ¶ˆæ¯ä¸­çš„ <code>image</code> å­—æ®µä¸º JPEG çš„ base64 å­—ç¬¦ä¸²ã€‚
    </div>

    <h2>ğŸš€ æ¥å…¥ç¤ºä¾‹</h2>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('python')">ğŸ Python æ¥å…¥</button>
        <button class="tab-btn" onclick="switchTab('frontend')">ğŸŒ å‰ç«¯æ¥å…¥</button>
    </div>

    <div id="tab-python" class="tab-content active">
        <h3>å®‰è£…ä¾èµ–</h3>
        <pre><code>pip install websockets opencv-python numpy</code></pre>

        <h3>å®Œæ•´ç¤ºä¾‹</h3>
        <pre><code>import asyncio
import websockets
import json
import base64
import cv2
import numpy as np

async def main():
    uri = "ws://127.0.0.1:8000/ws"

    async with websockets.connect(uri) as ws:
        await ws.send(json.dumps({"action": "start", "source": "rtsp://your-camera/stream"}))

        while True:
            msg = await ws.recv()
            data = json.loads(msg)

            if data.get("type") == "frame":
                payload = data.get("payload", {})
                print("payload:", payload)

                img_b64 = data.get("image")
                if img_b64:
                    img_bytes = base64.b64decode(img_b64)
                    frame = cv2.imdecode(np.frombuffer(img_bytes, np.uint8), cv2.IMREAD_COLOR)
                    if frame is not None:
                        cv2.imshow("congestion", frame)
                        if cv2.waitKey(1) & 0xFF == ord("q"):
                            break

            elif data.get("type") == "response":
                print("response:", data)

            elif data.get("type") == "error":
                print("error:", data)
                break

    cv2.destroyAllWindows()

asyncio.run(main())</code></pre>
    </div>

    <div id="tab-frontend" class="tab-content">
        <h3>æœ€å°ç¤ºä¾‹ï¼ˆæ— æ¸²æŸ“ï¼‰</h3>
        <p>å¤åˆ¶ä»¥ä¸‹ä»£ç ä¿å­˜ä¸º HTML æ–‡ä»¶å³å¯è¿è¡Œï¼Œæ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹è¾“å‡ºï¼š</p>

        <pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;body&gt;
  &lt;h1&gt;äº¤é€šæ‹¥æŒ¤è¯†åˆ«&lt;/h1&gt;
  &lt;img id="preview" style="max-width:640px;"&gt;
  &lt;div&gt;
    &lt;button id="start"&gt;Start&lt;/button&gt;
    &lt;button id="stop"&gt;Stop&lt;/button&gt;
  &lt;/div&gt;

  &lt;script&gt;
    const ws = new WebSocket('ws://127.0.0.1:8000/ws');
    const img = document.getElementById('preview');

    ws.onmessage = (e) =&gt; {
      const data = JSON.parse(e.data);
      if (data.type === 'frame') {
        if (data.image) {
          img.src = 'data:image/jpeg;base64,' + data.image;
        }
        console.log('payload:', data.payload);
      } else if (data.type === 'response') {
        console.log('response:', data);
      } else if (data.type === 'error') {
        console.error('error:', data.message || data);
      }
    };

    document.getElementById('start').onclick = () =&gt; {
      ws.send(JSON.stringify({ action: 'start', source: 'rtsp://...' }));
    };

    document.getElementById('stop').onclick = () =&gt; {
      ws.send(JSON.stringify({ action: 'stop' }));
    };
  &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
    </div>

    <h2>ğŸ“¤ å‘é€æ¶ˆæ¯</h2>

    <h3>å¯åŠ¨æ£€æµ‹</h3>
    <pre><code>{
  "action": "start",
  "source": "rtsp://user:pass@192.168.1.100:554/stream"
}</code></pre>

    <table>
        <tr>
            <th>å­—æ®µ</th>
            <th>ç±»å‹</th>
            <th>å¿…å¡«</th>
            <th>è¯´æ˜</th>
        </tr>
        <tr>
            <td><code>action</code></td>
            <td>string</td>
            <td>âœ…</td>
            <td>å›ºå®šå€¼ <code>"start"</code></td>
        </tr>
        <tr>
            <td><code>source</code></td>
            <td>string</td>
            <td>âœ…</td>
            <td>è§†é¢‘æºåœ°å€ï¼ˆRTSP/HTTP/æœ¬åœ°è·¯å¾„ï¼‰</td>
        </tr>
    </table>

    <h3>åœæ­¢æ£€æµ‹</h3>
    <pre><code>{
  "action": "stop"
}</code></pre>

    <h3>æŸ¥è¯¢çŠ¶æ€</h3>
    <pre><code>{
  "action": "status"
}</code></pre>

    <h2>ğŸ“¥ æ¥æ”¶æ¶ˆæ¯</h2>

    <h3>æŒ‡ä»¤å“åº”</h3>
    <pre><code>{
  "type": "response",
  "action": "start",
  "success": true,
  "source": "rtsp://...",
  "device": "cuda"
}</code></pre>

    <h3>æ£€æµ‹ç»“æœå¸§</h3>
    <pre><code>{
  "type": "frame",
  "payload": {
    "frame": 120,
    "congested": true,
    "total_vehicles": 8,
    "stopped_vehicles": 6,
    "zones": [
      {
        "id": 1,
        "vehicles": 4,
        "severity": "mild",
        "center": [320, 180],
        "vehicle_ids": [3, 7, 9, 11]
      }
    ]
  },
  "image": "base64..."
}</code></pre>

    <h3>Payload å­—æ®µè¯´æ˜</h3>

    <table>
        <tr>
            <th>å­—æ®µ</th>
            <th>ç±»å‹</th>
            <th>è¯´æ˜</th>
        </tr>
        <tr>
            <td><code>frame</code></td>
            <td>int</td>
            <td>å¸§ç¼–å·</td>
        </tr>
        <tr>
            <td><code>congested</code></td>
            <td>bool</td>
            <td>æ˜¯å¦æ‹¥å µ</td>
        </tr>
        <tr>
            <td><code>total_vehicles</code></td>
            <td>int</td>
            <td>è½¦è¾†æ€»æ•°ï¼ˆä»…æ‹¥å µæ—¶è¿”å›ï¼‰</td>
        </tr>
        <tr>
            <td><code>stopped_vehicles</code></td>
            <td>int</td>
            <td>é™æ­¢è½¦è¾†æ•°ï¼ˆä»…æ‹¥å µæ—¶è¿”å›ï¼‰</td>
        </tr>
        <tr>
            <td><code>zones</code></td>
            <td>array</td>
            <td>æ‹¥å µåŒºåˆ—è¡¨ï¼ˆä»…æ‹¥å µæ—¶è¿”å›ï¼‰</td>
        </tr>
    </table>

    <h3>æ‹¥å µåŒºå­—æ®µè¯´æ˜</h3>

    <table>
        <tr>
            <th>å­—æ®µ</th>
            <th>ç±»å‹</th>
            <th>è¯´æ˜</th>
        </tr>
        <tr>
            <td><code>id</code></td>
            <td>int</td>
            <td>æ‹¥å µåŒº ID</td>
        </tr>
        <tr>
            <td><code>vehicles</code></td>
            <td>int</td>
            <td>è¯¥åŒºåŸŸå†…è½¦è¾†æ•°</td>
        </tr>
        <tr>
            <td><code>severity</code></td>
            <td>string</td>
            <td>æ‹¥å µç­‰çº§ï¼ˆmild/moderate/severeï¼‰</td>
        </tr>
        <tr>
            <td><code>center</code></td>
            <td>array</td>
            <td>åŒºåŸŸä¸­å¿ƒç‚¹åæ ‡</td>
        </tr>
        <tr>
            <td><code>vehicle_ids</code></td>
            <td>array</td>
            <td>åŒºåŸŸå†…è½¦è¾† ID åˆ—è¡¨</td>
        </tr>
    </table>

    <div class="footer">
        <p><a href="index.html">â† è¿”å›äº¤é€šæ‹¥æŒ¤è¯†åˆ«</a></p>
    </div>

    <script>
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            document.querySelector(`[onclick=\"switchTab('${tab}')\"]`).classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
        }
    </script>

</body>

</html>
