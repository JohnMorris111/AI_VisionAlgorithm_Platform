<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIæ¥å£æ–‡æ¡£ - æ¶ˆé˜²é€šé“å ç”¨æ£€æµ‹</title>
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.1/github-markdown-light.min.css">
    <style>
        body {
            box-sizing: border-box;
            max-width: 900px;
            margin: 0 auto;
            padding: 45px;
            background: #fff;
        }

        .markdown-body h1 {
            border-bottom: 1px solid #d1d9e0;
            padding-bottom: 0.3em;
        }

        .markdown-body h2 {
            border-bottom: 1px solid #d1d9e0;
            padding-bottom: 0.3em;
            margin-top: 32px;
        }

        .breadcrumb {
            margin-bottom: 16px;
            font-size: 14px;
        }

        .breadcrumb a {
            color: #0969da;
            text-decoration: none;
        }

        /* é€‰é¡¹å¡ */
        .tabs {
            display: flex;
            border-bottom: 1px solid #d1d9e0;
            margin: 24px 0 0 0;
        }

        .tab-btn {
            padding: 12px 24px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #656d76;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
        }

        .tab-btn.active {
            color: #0969da;
            border-bottom-color: #fd8c73;
        }

        .tab-btn:hover {
            color: #0969da;
        }

        .tab-content {
            display: none;
            padding: 24px 0;
        }

        .tab-content.active {
            display: block;
        }

        pre {
            background: #f6f8fa;
            border-radius: 6px;
            padding: 16px;
            overflow: auto;
            font-size: 13px;
        }

        code {
            background: rgba(175, 184, 193, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 85%;
        }

        pre code {
            background: none;
            padding: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
        }

        th,
        td {
            border: 1px solid #d1d9e0;
            padding: 10px 16px;
            text-align: left;
        }

        th {
            background: #f6f8fa;
        }

        .tip {
            padding: 12px 16px;
            border-radius: 6px;
            margin: 16px 0;
            background: #ddf4ff;
            border-left: 4px solid #0969da;
            font-size: 14px;
        }

        .footer {
            margin-top: 48px;
            padding-top: 24px;
            border-top: 1px solid #d1d9e0;
            color: #656d76;
            font-size: 14px;
        }
    </style>
</head>

<body class="markdown-body">

    <div class="breadcrumb">
        <a href="../../index.html">å¹³å°é¦–é¡µ</a> / <a href="index.html">æ¶ˆé˜²é€šé“å ç”¨æ£€æµ‹</a> / APIæ–‡æ¡£
    </div>

    <h1>ğŸ“– API æ¥å£æ–‡æ¡£</h1>
    <p>WebSocket å®æ—¶é€šä¿¡æ¥å£ï¼Œæ”¯æŒ Python åç«¯å’Œå‰ç«¯ JavaScript ä¸¤ç§æ¥å…¥æ–¹å¼ã€‚</p>

    <h2>ğŸ”Œ æ¥å£åœ°å€</h2>
    <pre><code>ws://æœåŠ¡å™¨IP:8000/ws</code></pre>

    <h2>ğŸ“¨ æ¶ˆæ¯æ ¼å¼</h2>

    <table>
        <tr>
            <th>æ–¹å‘</th>
            <th>æ¶ˆæ¯ç±»å‹</th>
            <th>æ ¼å¼</th>
            <th>è¯´æ˜</th>
        </tr>
        <tr>
            <td>å‘é€</td>
            <td><code>start</code></td>
            <td>JSON</td>
            <td>å¯åŠ¨æ£€æµ‹</td>
        </tr>
        <tr>
            <td>å‘é€</td>
            <td><code>stop</code></td>
            <td>JSON</td>
            <td>åœæ­¢æ£€æµ‹</td>
        </tr>
        <tr>
            <td>æ¥æ”¶</td>
            <td><code>payload</code></td>
            <td>JSON</td>
            <td>æ£€æµ‹ç»“æœæ•°æ®</td>
        </tr>
        <tr>
            <td>æ¥æ”¶</td>
            <td><code>frame</code></td>
            <td>JSON + äºŒè¿›åˆ¶</td>
            <td>å¸¦æ ‡æ³¨çš„è§†é¢‘å¸§ï¼ˆJPEGï¼‰</td>
        </tr>
        <tr>
            <td>æ¥æ”¶</td>
            <td><code>error</code></td>
            <td>JSON</td>
            <td>é”™è¯¯ä¿¡æ¯</td>
        </tr>
        <tr>
            <td>æ¥æ”¶</td>
            <td><code>started</code> / <code>stopped</code></td>
            <td>JSON</td>
            <td>çŠ¶æ€å˜æ›´é€šçŸ¥</td>
        </tr>
    </table>

    <div class="tip">
        ğŸ“¹ <strong>è§†é¢‘å¸§è¯´æ˜ï¼š</strong> <code>frame</code> æ¶ˆæ¯åç´§è·Ÿä¸€æ¡<strong>äºŒè¿›åˆ¶æ¶ˆæ¯</strong>ï¼Œå†…å®¹ä¸º JPEG æ ¼å¼çš„æ ‡æ³¨å¸§å›¾ç‰‡ã€‚
    </div>

    <h2>ğŸš€ æ¥å…¥ç¤ºä¾‹</h2>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('python')">ğŸ Python æ¥å…¥</button>
        <button class="tab-btn" onclick="switchTab('frontend')">ğŸŒ å‰ç«¯æ¥å…¥</button>
    </div>

    <!-- Python æ¥å…¥ -->
    <div id="tab-python" class="tab-content active">
        <h3>å®‰è£…ä¾èµ–</h3>
        <pre><code>pip install websockets opencv-python numpy</code></pre>

        <h3>å®Œæ•´ç¤ºä¾‹</h3>
        <pre><code>import asyncio
import websockets
import json
import cv2
import numpy as np

async def main():
    uri = "ws://127.0.0.1:8000/ws"
    
    async with websockets.connect(uri) as ws:
        # 1. å¯åŠ¨æ£€æµ‹
        await ws.send(json.dumps({
            "type": "start",
            "source": "rtsp://your-camera/stream", # æˆ–æœ¬åœ°æ–‡ä»¶è·¯å¾„
            "conf_thres": 0.65,
            "frame_gap": 2
        }))
        
        # 2. æ¥æ”¶ loop
        while True:
            try:
                msg = await ws.recv()
            except websockets.exceptions.ConnectionClosed:
                break
            
            # äºŒè¿›åˆ¶æ¶ˆæ¯ = è§†é¢‘å¸§ (JPEG)
            if isinstance(msg, bytes):
                frame = cv2.imdecode(np.frombuffer(msg, np.uint8), cv2.IMREAD_COLOR)
                if frame is not None:
                    cv2.imshow("Preview", frame)
                    if cv2.waitKey(1) & 0xFF == ord('q'): break
                continue
            
            # JSON æ¶ˆæ¯
            try:
                data = json.loads(msg)
            except json.JSONDecodeError:
                continue
            
            if data.get("type") == "payload":
                # å¤„ç†æ£€æµ‹ç»“æœ
                lanes = data['payload']['lanes']
                polluted_count = data['payload']['stats']['occupied_lanes']
                print(f"Frame {data['frame_idx']}: {polluted_count} lanes polluted")
                
            elif data.get("type") == "error":
                print(f"Error: {data.get('message')}")
                break
                
            elif data.get("type") == "stopped":
                print("Stopped")
                break

    cv2.destroyAllWindows()

asyncio.run(main())</code></pre>
    </div>

    <!-- å‰ç«¯æ¥å…¥ -->
    <div id="tab-frontend" class="tab-content">
        <h3>æœ€å°ç¤ºä¾‹ï¼ˆæ— æ¸²æŸ“ï¼‰</h3>
        <pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;body&gt;
  &lt;h1&gt;æ¶ˆé˜²é€šé“æ£€æµ‹&lt;/h1&gt;
  &lt;img id="video" style="max-width:640px;"&gt;
  &lt;div&gt;
      &lt;button id="start"&gt;Start&lt;/button&gt;
      &lt;button id="stop"&gt;Stop&lt;/button&gt;
  &lt;/div&gt;

  &lt;script&gt;
    const ws = new WebSocket('ws://127.0.0.1:8000/ws');
    const img = document.getElementById('video');
    
    ws.onmessage = (e) =&gt; {
      if (e.data instanceof Blob) {
        img.src = URL.createObjectURL(e.data);
      } else {
        const data = JSON.parse(e.data);
        if (data.type === 'payload') {
            const stats = data.payload.stats;
            console.log(`Polluted Lanes: ${stats.occupied_lanes}/${stats.total_lanes}`);
        }
      }
    };
    
    document.getElementById('start').onclick = () =&gt; {
      ws.send(JSON.stringify({ 
          type: 'start', 
          source: 'rtsp://...',
          frame_gap: 5
      }));
    };
    
    document.getElementById('stop').onclick = () =&gt; {
      ws.send(JSON.stringify({ type: 'stop' }));
    };
  &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
    </div>

    <h2>ğŸ“¤ å‘é€æ¶ˆæ¯</h2>

    <h3>å¯åŠ¨æ£€æµ‹</h3>
    <pre><code>{
  "type": "start",
  "source": "rtsp://user:pass@192.168.1.100:554/stream",
  "conf_thres": 0.65,  // ç½®ä¿¡åº¦é˜ˆå€¼
  "frame_gap": 5       // è·³å¸§é—´éš”
}</code></pre>

    <table>
        <tr>
            <th>å­—æ®µ</th>
            <th>ç±»å‹</th>
            <th>å¿…å¡«</th>
            <th>è¯´æ˜</th>
        </tr>
        <tr>
            <td><code>type</code></td>
            <td>string</td>
            <td>âœ…</td>
            <td>å›ºå®šå€¼ <code>"start"</code></td>
        </tr>
        <tr>
            <td><code>source</code></td>
            <td>string</td>
            <td>âœ…</td>
            <td>è§†é¢‘æºåœ°å€ï¼ˆRTSP/RTMP/HTTP/æœ¬åœ°è·¯å¾„ï¼‰</td>
        </tr>
        <tr>
            <td><code>conf_thres</code></td>
            <td>float</td>
            <td>âŒ</td>
            <td>é»˜è®¤ 0.65</td>
        </tr>
        <tr>
            <td><code>frame_gap</code></td>
            <td>int</td>
            <td>âŒ</td>
            <td>é»˜è®¤ 5</td>
        </tr>
    </table>

    <h3>åœæ­¢æ£€æµ‹</h3>
    <pre><code>{"type": "stop"}</code></pre>

    <h2>ğŸ“¥ æ¥æ”¶æ¶ˆæ¯</h2>

    <h3>æ£€æµ‹ç»“æœ (Payload)</h3>
    <pre><code>{
  "type": "payload",
  "ts": 1712345678.123,
  "payload": {
    "frame_idx": 100,
    "timestamp": 4.0,
    "lanes": [
      {
        "lane_id": "main_lane",
        "status": "æ±¡æŸ“",       // "æ±¡æŸ“" æˆ– "æ­£å¸¸"
        "polluted": true,      // true æˆ– false
        "confidence": 0.95,
        "occupants": [         // ä¾µå ç‰©åˆ—è¡¨
            {
                "cls_name": "car",
                "bbox": [100, 100, 200, 200]
            }
        ]
      }
    ],
    "stats": {
        "total_lanes": 1,
        "occupied_lanes": 1,
        "total_occupants": 1
    }
  }
}</code></pre>

    <h2>ğŸ“Š å¼‚å¸¸äº‹ä»¶æŠ“æ‹</h2>

    <p>å½“æ£€æµ‹åˆ°é€šé“è¢«å ç”¨æ—¶ï¼Œç³»ç»Ÿè‡ªåŠ¨åœ¨ <code>result/abnormal_captures/</code> ç›®å½•ä¸‹ç”Ÿæˆäº‹ä»¶æ–‡ä»¶å¤¹ï¼š</p>

    <pre><code>result/abnormal_captures/
â””â”€â”€ event_12_34_150/           // å‘½åæ ¼å¼: event_{timestamp}_{frame_idx}
    â”œâ”€â”€ raw.jpg                // åŸå§‹è§†é¢‘å¸§
    â”œâ”€â”€ vis.jpg                // å¸¦æ ‡æ³¨çš„å¯è§†åŒ–å¸§
    â””â”€â”€ result.csv             // è¯¥æ—¶åˆ»çš„è¿è§„æ•°æ®ï¼ˆScene ID, BBox, Time...ï¼‰</code></pre>

    <div class="footer">
        <p><a href="index.html">â† è¿”å›äº§å“é¡µ</a></p>
    </div>

    <script>
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
        }
    </script>

</body>

</html>
