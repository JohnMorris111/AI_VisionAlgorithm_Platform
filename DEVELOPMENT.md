# AI åœè½¦è¿è§„æ£€æµ‹æœåŠ¡ - å¼€å‘æ–‡æ¡£

æœ¬æ–‡æ¡£é¢å‘å¼€å‘è€…ï¼Œè§£é‡Šå¦‚ä½•ä»é›¶æ„å»ºä¸‰å±‚æ¶æ„çš„è¿åœæ£€æµ‹æœåŠ¡ã€‚

---

## ğŸ§  æ ¸å¿ƒå¼€å‘æ€æƒ³ï¼šå‘ç”µæœº â†’ ç”µé—¸ â†’ é¥æ§å™¨

è¿™å¥—ä»£ç çš„æ ¸å¿ƒæ¶æ„å¯ä»¥ç”¨ä¸€ä¸ªæ¯”å–»æ¥ç†è§£ï¼š**å»ºä¸€ä¸ªè¿œç¨‹å¯æ§çš„å‘ç”µç«™ã€‚**

### ä¸‰å±‚æ¶æ„æ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 3: FastAPI / WebSocket (é¥æ§å™¨)                           â”‚
â”‚  - listen_commands(): ç›‘å¬å®¢æˆ·ç«¯çš„é¥æ§æŒ‡ä»¤                        â”‚
â”‚  - stream_results():  æŠŠä»ªè¡¨ç›˜æ•°æ®ï¼ˆæ£€æµ‹ç»“æœï¼‰æ¨é€ç»™è¿œç¨‹æ˜¾ç¤ºå±       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Layer 2: StreamWorker (ç”µé—¸å¼€å…³)                                â”‚
â”‚  - start():  åˆé—¸é€šç”µï¼Œå¯åŠ¨å‘ç”µæœº                                 â”‚
â”‚  - stop():   æ‹‰é—¸æ–­ç”µï¼Œä¼˜é›…å…³æœº                                   â”‚
â”‚  - _inference_loop(): å‘ç”µæœºå†…éƒ¨çš„æ—‹è½¬é€»è¾‘ï¼ˆæ”¹é€ è‡ª mainloopï¼‰       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Layer 1: suanfa.py (å‘ç”µæœº)                                     â”‚
â”‚  - mainloop():  åŸå‹ä»£ç ï¼Œåªç®¡åŸ‹å¤´æ¨ç†ï¼Œä¸å…³å¿ƒè°åœ¨æ§åˆ¶å®ƒ             â”‚
â”‚  - parkingdetect() / panduan(): æ ¸å¿ƒç®—æ³•æ­¥éª¤                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¼€å‘é¡ºåºï¼ˆä»åº•å‘ä¸Šï¼‰

| é˜¶æ®µ | å±‚çº§ | æ ¸å¿ƒäº§ç‰© | æ¯”å–» |
|------|------|---------|------|
| **Step 1** | åº•å±‚ç®—æ³• | `mainloop` åŸå‹ | **å‘ç”µæœº**ï¼šåªç®¡åŸ‹å¤´å‘ç”µ |
| **Step 2** | StreamWorker | `start/stop` + `_inference_loop` | **ç”µé—¸å¼€å…³**ï¼šæ§åˆ¶å‘ç”µæœºçš„å¯åœ |
| **Step 3** | FastAPI/WebSocket | `listen_commands` + `stream_results` | **é¥æ§å™¨**ï¼šè¿œç¨‹æ“æ§ç”µé—¸ + æŸ¥çœ‹ä»ªè¡¨ç›˜ |

> [!IMPORTANT]
> **å¼€å‘å¿…é¡»æŒ‰æ­¤é¡ºåº**ï¼šå…ˆå†™å‘ç”µæœºï¼Œå†è£…ç”µé—¸ï¼Œæœ€åé…é¥æ§å™¨ã€‚
> è·³è¿‡ä»»ä½•ä¸€æ­¥éƒ½ä¼šå¯¼è‡´æ¶æ„æ··ä¹±ã€‚

---

## ğŸ”„ ä»"æµç¨‹å¯¼å‘"åˆ°"æ§åˆ¶å¯¼å‘"

### æµç¨‹å¯¼å‘ Demoï¼ˆåŸå§‹è„šæœ¬ï¼‰

```
å¯åŠ¨ç¨‹åº â†’ åŠ è½½æ¨¡å‹ â†’ æ‰“å¼€è§†é¢‘ â†’ while True æ¨ç† â†’ è§†é¢‘ç»“æŸ â†’ ç¨‹åºç»ˆæ­¢
```

*   **ç‰¹ç‚¹**ï¼šä»»åŠ¡ç”Ÿå‘½å‘¨æœŸ = ç¨‹åºç”Ÿå‘½å‘¨æœŸã€‚
*   **å±€é™**ï¼šæ¢è§†é¢‘æºå¿…é¡»é‡å¯ç¨‹åºã€‚

### æ§åˆ¶å¯¼å‘äº§å“ï¼ˆæœåŠ¡åŒ–åï¼‰

```
ç¨‹åºå¯åŠ¨ï¼ˆFastAPI å¾…å‘½ï¼‰
        â”‚
        â”œâ”€â”€ é¥æ§å™¨å‘é€ start â”€â”€â†’ ç”µé—¸åˆé—¸ â†’ å‘ç”µæœºå¯åŠ¨
        â”‚
        â””â”€â”€ é¥æ§å™¨å‘é€ stop â”€â”€â”€â†’ ç”µé—¸æ‹‰é—¸ â†’ å‘ç”µæœºåœæ­¢ â†’ ç­‰å¾…ä¸‹ä¸€æ¬¡ start
```

*   **ç‰¹ç‚¹**ï¼šç®—æ³•å®Œå…¨"è¢«åŠ¨å“åº”"ï¼Œç”±é¥æ§å™¨æŒ‡ä»¤æ§åˆ¶ã€‚
*   **ä¼˜åŠ¿**ï¼šWeb æœåŠ¡ä¸ç”¨é‡å¯ï¼Œå³å¯åŠ¨æ€åˆ‡æ¢ä»»åŠ¡ã€‚

---

## ğŸ“Œ `start()` æ–¹æ³•è¯¦è§£ï¼ˆç”µé—¸åˆé—¸çš„ 7 ä¸ªåŠ¨ä½œï¼‰

| æ­¥éª¤ | ä»£ç /åŠ¨ä½œ | ç›®çš„ |
|------|----------|------|
| 1 | `self.stop()` | å…ˆæ‹‰æ—§ç”µé—¸ï¼Œé˜²æ­¢ä¸¤å°å‘ç”µæœºåŒæ—¶è·‘ |
| 2 | `with self._lock:` | é”ä½æ§åˆ¶å®¤ï¼Œé˜²æ­¢åˆ«äººä¹±åŠ¨ |
| 3 | æ¸…ç©º `latest_result` ç­‰å…±äº«å˜é‡ | æ¸…ç†ä¸Šä¸€è½®çš„æ®‹ç•™æ•°æ® |
| 4 | `self._stop_event.clear()` | æŠŠçº¢ç¯åˆ‡æ¢ä¸ºç»¿ç¯ |
| 5 | `self._detector = _create_detector(...)` | ç»„è£…æ–°å‘ç”µæœºï¼ˆåŠ è½½æ¨¡å‹ï¼‰ |
| 6 | `self._thread = Thread(target=_inference_loop)` | å‡†å¤‡å¯åŠ¨æŒ‰é’® |
| 7 | `self._thread.start()` | æŒ‰ä¸‹æŒ‰é’®ï¼Œå‘ç”µæœºå¼€å§‹è½¬åŠ¨ |

---

## ğŸ”‘ StreamWorker ä»£ç ç»„ç»‡è§„èŒƒ

ä¸ºäº†è®©å¼€å‘è€…å¿«é€Ÿç†è§£ä¸»çº¿é€»è¾‘ï¼Œ`StreamWorker` ç±»çš„æ–¹æ³•åº”æŒ‰ä»¥ä¸‹é¡ºåºæ’åˆ—ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Section 1: åˆå§‹åŒ– (__init__)                                    â”‚
â”‚  - å®šä¹‰æ‰€æœ‰æˆå‘˜å˜é‡                                               â”‚
â”‚  - ä¸€çœ¼çœ‹æ¸…è¿™ä¸ªç±»"æœ‰ä»€ä¹ˆ"                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Section 2: å…¬å¼€æ¥å£ (API)                     â¬…ï¸ å¼€å‘é‡ç‚¹å…³æ³¨    â”‚
â”‚  - is_running()                                                  â”‚
â”‚  - start()                                                       â”‚
â”‚  - stop()                                                        â”‚
â”‚  è¯´æ˜: è¿™æ˜¯å¤–éƒ¨è°ƒç”¨çš„å…¥å£ï¼Œä¿®æ”¹æ¥å£è¡Œä¸ºæ—¶ä¸»è¦æ”¹è¿™é‡Œ                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Section 3: ä¸»çº¿é€»è¾‘ (Core Loop)               â¬…ï¸ å¼€å‘é‡ç‚¹å…³æ³¨    â”‚
â”‚  - _inference_loop()                                             â”‚
â”‚  è¯´æ˜: è¿™æ˜¯æ ¸å¿ƒæ¨ç†å¾ªç¯ï¼Œç®—æ³•æ”¹åŠ¨/æµç¨‹å˜æ›´ä¸»è¦æ”¹è¿™é‡Œ                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Section 4: è¾…åŠ©å‡½æ•° - æ£€æµ‹å™¨å·¥å‚              ğŸ”§ å¾ˆå°‘éœ€è¦ä¿®æ”¹      â”‚
â”‚  - _create_detector()                                            â”‚
â”‚  - _create_roi_detector()                                        â”‚
â”‚  - _create_punish_detector()                                     â”‚
â”‚  - _parse_int_list()                                             â”‚
â”‚  è¯´æ˜: åˆ›å»ºæ£€æµ‹å™¨å®ä¾‹ï¼Œé™¤éæ–°å¢ç®—æ³•ç±»å‹å¦åˆ™ä¸éœ€æ”¹åŠ¨                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Section 5: è¾…åŠ©å‡½æ•° - ç»“æœå¤„ç†                ğŸ”§ å¾ˆå°‘éœ€è¦ä¿®æ”¹      â”‚
â”‚  - _build_frame_result()                                         â”‚
â”‚  - _render_preview()                                             â”‚
â”‚  è¯´æ˜: å°†ç®—æ³•è¾“å‡ºè½¬ä¸º JSON/JPEGï¼Œæ”¹å˜è¾“å‡ºæ ¼å¼æ—¶ä¿®æ”¹                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Section 6: è¾…åŠ©å‡½æ•° - è¯æ®ä¿å­˜                ğŸ”§ å¾ˆå°‘éœ€è¦ä¿®æ”¹      â”‚
â”‚  - _save_violation_evidence()                                    â”‚
â”‚  - _write_evidence_files()                                       â”‚
â”‚  è¯´æ˜: ä¿å­˜è¿è§„æˆªå›¾å’ŒCSVï¼Œæ”¹å˜ä¿å­˜ç­–ç•¥æ—¶ä¿®æ”¹                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸»çº¿é€»è¾‘å¯¼èˆªå›¾

```
start() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                      â”‚
  â”œâ”€> stop()            // å…ˆåœæ­¢æ—§çº¿ç¨‹                   â”‚
  â”‚                                                      â”‚
  â”œâ”€> _create_detector() // åˆ›å»ºç®—æ³•å¼•æ“                  â”‚  å…¬å¼€æ¥å£
  â”‚                                                      â”‚
  â””â”€> Thread(_inference_loop) // å¯åŠ¨åå°çº¿ç¨‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜
                                                        â”‚
_inference_loop() â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â”‚  while not stop_event:
  â”‚    â”‚
  â”‚    â”œâ”€> detector.model.track()     // YOLO æ¨ç†
  â”‚    â”œâ”€> detector.parkingdetect()   // Stage 1
  â”‚    â”œâ”€> detector.panduan()         // Stage 2
  â”‚    â”‚
  â”‚    â”œâ”€> _build_frame_result()      // æ„å»ºè¾“å‡º â”€â”€â”€â”€â”€â”
  â”‚    â”œâ”€> _save_violation_evidence() // ä¿å­˜è¯æ®      â”‚ è¾…åŠ©å‡½æ•°
  â”‚    â””â”€> _render_preview()          // æ¸²æŸ“é¢„è§ˆ â”€â”€â”€â”€â”€â”˜
  â”‚
  â””â”€> cap.release()  // æ¸…ç†èµ„æº


stop() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  â”‚
  â”œâ”€> stop_event.set()   // é€šçŸ¥å¾ªç¯é€€å‡º
  â””â”€> thread.join()      // ç­‰å¾…çº¿ç¨‹ç»“æŸ
```

### å¼€å‘æ—¶çš„å…³æ³¨ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | æ–¹æ³• | ä½•æ—¶éœ€è¦ä¿®æ”¹ |
|--------|------|-------------|
| â­â­â­ | `_inference_loop()` | æ”¹å˜æ¨ç†æµç¨‹ã€æ–°å¢å¤„ç†æ­¥éª¤ |
| â­â­â­ | `start()` / `stop()` | æ”¹å˜å¯åŠ¨/åœæ­¢è¡Œä¸º |
| â­â­ | `_build_frame_result()` | æ”¹å˜ JSON è¾“å‡ºç»“æ„ |
| â­ | `_create_detector()` | æ–°å¢ç®—æ³•ç±»å‹ |
| â­ | `_render_preview()` | æ”¹å˜é¢„è§ˆå›¾æ ·å¼ |
| â­ | `_save_violation_evidence()` | æ”¹å˜è¯æ®ä¿å­˜ç­–ç•¥ |

---

## ç›®å½•

1. [æ¶æ„æ¦‚è§ˆ](#æ¶æ„æ¦‚è§ˆ)
2. [Step 1: ç®—æ³•å±‚ IllegalParkingDetector](#step-1-ç®—æ³•å±‚-illegalparkingdetector)
3. [Step 2: mainloop æœ¬åœ°è°ƒè¯•åŸå‹](#step-2-mainloop-æœ¬åœ°è°ƒè¯•åŸå‹)
4. [Step 3: StreamWorker æœåŠ¡åŒ–å°è£…](#step-3-streamworker-æœåŠ¡åŒ–å°è£…)
5. [Step 4: FastAPI æ¥å£å±‚](#step-4-fastapi-æ¥å£å±‚)

---

## æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 1: API æ¥å£å±‚ (FastAPI + WebSocket)                   â”‚
â”‚  - å¯¹å¤–æš´éœ² HTTP/WebSocket æ¥å£                               â”‚
â”‚  - æ¥æ”¶ start/stop æŒ‡ä»¤ï¼Œæ¨é€æ£€æµ‹ç»“æœ                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Layer 2: æœåŠ¡åè°ƒå±‚ (StreamWorker)                          â”‚
â”‚  - å°è£… mainloop ä¸ºå¯æ§çš„åå°çº¿ç¨‹                              â”‚
â”‚  - æä¾› start()/stop() æ¥å£                                  â”‚
â”‚  - ç»´æŠ¤çº¿ç¨‹å®‰å…¨çš„å…±äº«çŠ¶æ€                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Layer 3: ç®—æ³•å¼•æ“å±‚ (IllegalParkingDetector)                â”‚
â”‚  - çº¯ç®—æ³•é€»è¾‘ï¼šæ£€æµ‹ â†’ è·Ÿè¸ª â†’ åœè½¦åˆ¤å®š â†’ åŒºåŸŸåˆ¤å®š                 â”‚
â”‚  - ä¸å…³å¿ƒå¦‚ä½•è¢«è°ƒç”¨ï¼Œåªå¤„ç†å•å¸§æˆ–æä¾› mainloop                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¼€å‘é¡ºåº**: ä»ä¸‹å¾€ä¸Šï¼Œå…ˆå†™ç®—æ³•å±‚ï¼Œå†å°è£…æˆæœåŠ¡ã€‚

---

## Step 1: ç®—æ³•å±‚ IllegalParkingDetector

**ç›®æ ‡**: å®ç°çº¯ç²¹çš„è¿åœæ£€æµ‹ç®—æ³•ï¼Œä¸ä¾èµ–ä»»ä½•æœåŠ¡/ç½‘ç»œæ¡†æ¶ã€‚

**æ–‡ä»¶**: `function/suanfa.py`

### 1.1 æ ¸å¿ƒæ•°æ®ç»“æ„

```python
class IllegalParkingDetector:
    def __init__(self, weights_path, source, ...):
        # æ¨¡å‹ç›¸å…³
        self.model = None           # YOLO æ¨¡å‹å®ä¾‹
        self.weights_path = weights_path
        
        # è§†é¢‘ç›¸å…³
        self.source = source        # è§†é¢‘è·¯å¾„/RTSP URL
        
        # è·Ÿè¸ªçŠ¶æ€ (æŒ‰ track_id å­˜å‚¨)
        self._track_state = {}      # {tid: {foot_ema, still, locked, ...}}
        self._parked_ids = set()    # å½“å‰åœè½¦çš„ ID é›†åˆ
        
        # é˜ˆå€¼å‚æ•°
        self.stop_eps_pix = 4.0     # é™æ­¢åˆ¤å®šé˜ˆå€¼ (åƒç´ )
        self.min_stop_frames = 5    # æœ€å°‘é™æ­¢å¸§æ•°
```

### 1.2 æ ¸å¿ƒæ–¹æ³•

#### `parkingdetect()` - Stage 1 åœè½¦åˆ¤å®š

```python
def parkingdetect(self, result, frame_index, M):
    """
    è¾“å…¥:
        result: YOLO æ£€æµ‹ç»“æœ (å« boxes.id è·Ÿè¸ªID)
        frame_index: å½“å‰å¸§å·
        M: ä»¿å°„å˜æ¢çŸ©é˜µ (ç›¸æœºè¿åŠ¨è¡¥å¿)
    
    è¾“å‡º:
        {track_id: parked_frames}  # åœè½¦è½¦è¾†åŠå…¶é™æ­¢å¸§æ•°
    
    é€»è¾‘:
        1. æå–æ¯ä¸ªç›®æ ‡çš„è„šç‚¹ (bbox åº•éƒ¨ä¸­å¿ƒ)
        2. EMA å¹³æ»‘åæ ‡ï¼ŒæŠ‘åˆ¶æ£€æµ‹æ¡†æŠ–åŠ¨
        3. ç”¨ M å°†ä¸Šä¸€å¸§è„šç‚¹æŠ•å½±åˆ°å½“å‰å¸§ (è¡¥å¿ç›¸æœºè¿åŠ¨)
        4. è®¡ç®—æ®‹å·®ï¼Œå°äºé˜ˆå€¼åˆ™ç´¯ç§¯é™æ­¢å¸§
        5. é™æ­¢å¸§è¾¾æ ‡åˆ™æ ‡è®°ä¸º"åœè½¦"
    """
    parked = {}
    for track_id, box in zip(result.boxes.id, result.boxes.xyxy):
        foot = (cx, bottom_y)  # è„šç‚¹
        state = self._track_state.get(tid)
        
        # EMA å¹³æ»‘
        foot_ema = alpha * foot + (1 - alpha) * prev_ema
        
        # è¿åŠ¨è¡¥å¿
        prev_warp = M @ prev_ema
        residual = |foot_ema - prev_warp|
        
        # çŠ¶æ€æœºæ›´æ–°
        if residual <= stop_eps_pix:
            state["still"] += 1
            if state["still"] >= min_stop_frames:
                state["locked"] = True  # é”å®šä¸ºåœè½¦
                parked[tid] = state["still"]
    
    return parked
```

#### `panduan()` - Stage 2 åŒºåŸŸåˆ¤å®š

```python
def panduan(self, frame, result, parked, min_frames, frame_index):
    """
    è¾“å…¥:
        frame: å½“å‰å¸§å›¾åƒ
        result: YOLO æ£€æµ‹ç»“æœ
        parked: Stage 1 è¾“å‡ºçš„åœè½¦è½¦è¾†
        min_frames: è§¦å‘äºŒé˜¶æ®µçš„æœ€å°å¸§æ•°
    
    è¾“å‡º:
        {
            "status_map": {tid: "åˆæ³•åœè½¦"/"è¿è§„åœè½¦"},
            "evidence": {"right": [...], "wrong": [...]}
        }
    
    é€»è¾‘:
        1. æ£€æŸ¥æ˜¯å¦æœ‰ parked_frames >= é˜ˆå€¼ çš„è½¦è¾†
        2. è·å–åŒºåŸŸä¿¡æ¯ (ROI æŠ•å½± æˆ– åŒºåŸŸæ£€æµ‹æ¨¡å‹)
        3. è®¡ç®—è½¦è¾† bbox ä¸åŒºåŸŸçš„é‡å 
        4. å‘½ä¸­åˆæ³•åŒº â†’ "åˆæ³•åœè½¦"ï¼Œå‘½ä¸­è¿è§„åŒº â†’ "è¿è§„åœè½¦"
        5. é”å®šåˆ¤å®šç»“æœ (panduan_locked = True)
    """
```

---

## Step 2: mainloop æœ¬åœ°è°ƒè¯•åŸå‹

**ç›®æ ‡**: åœ¨æœ¬åœ°è·‘èµ·æ¥ï¼Œç”¨ `cv2.imshow()` çœ‹æ•ˆæœã€‚

**ä½ç½®**: `IllegalParkingDetector.mainloop()` æ–¹æ³•

### 2.1 åŸºæœ¬ç»“æ„

```python
def mainloop(self):
    # 1. åŠ è½½æ¨¡å‹
    self.load_model()
    
    # 2. æ‰“å¼€è§†é¢‘
    cap = cv2.VideoCapture(self.source)
    prev_gray = None
    frame_index = 0
    
    # 3. ä¸»å¾ªç¯
    while True:
        ret, frame = cap.read()
        if not ret:
            break
        
        # 4. YOLO æ¨ç†
        results = self.model.track(frame, ...)
        result = self.keepid(results[0])
        
        # 5. è¿åŠ¨è¡¥å¿
        gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)
        M = self._motion_warp(prev_gray, gray)
        prev_gray = gray
        
        # 6. Stage 1: åœè½¦åˆ¤å®š
        parked = self.parkingdetect(result, frame_index, M)
        
        # 7. Stage 2: åŒºåŸŸåˆ¤å®š
        panduan_result = self.panduan(frame, result, parked, ...)
        
        # 8. æ¸²æŸ“å¯è§†åŒ–
        self._draw_boxes(frame, result, panduan_result)
        
        # 9. æ˜¾ç¤º
        cv2.imshow("Detector", frame)
        if cv2.waitKey(1) == ord('q'):
            break
        
        frame_index += 1
    
    cap.release()
    cv2.destroyAllWindows()
```

### 2.2 mainloop çš„å±€é™æ€§

| é—®é¢˜ | è¯´æ˜ |
|------|------|
| **é˜»å¡** | `while True` é˜»å¡ä¸»çº¿ç¨‹ï¼Œæ— æ³•å“åº”å…¶ä»–è¯·æ±‚ |
| **æ— æ³•è¿œç¨‹æ§åˆ¶** | åªèƒ½æŒ‰ 'q' é”®é€€å‡ºï¼Œæ²¡æœ‰ API |
| **æ— æ³•å…±äº«ç»“æœ** | `self.payload` åªåœ¨ç±»å†…éƒ¨ï¼Œå¤–éƒ¨æ— æ³•è¯»å– |
| **æ— æ³•é‡å¯** | é€€å‡ºåéœ€è¦é‡æ–°åˆ›å»ºå®ä¾‹ |

**ç»“è®º**: mainloop é€‚åˆæœ¬åœ°è°ƒè¯•ï¼Œä½†æ— æ³•ç›´æ¥ç”¨äºæœåŠ¡åŒ–éƒ¨ç½²ã€‚

---

## Step 3: StreamWorker æœåŠ¡åŒ–å°è£…

**ç›®æ ‡**: æŠŠ mainloop å°è£…æˆå¯é€šè¿‡ API æ§åˆ¶çš„åå°æœåŠ¡ã€‚

**æ–‡ä»¶**: `parkingdetector130.py` ä¸­çš„ `StreamWorker` ç±»

### 3.1 éœ€è¦è§£å†³çš„é—®é¢˜

| é—®é¢˜ | mainloop æ–¹æ¡ˆ | StreamWorker æ–¹æ¡ˆ |
|------|--------------|-------------------|
| **å¦‚ä½•å¯åŠ¨** | ç›´æ¥è°ƒç”¨ `mainloop()` | `start()` åˆ›å»ºåå°çº¿ç¨‹ |
| **å¦‚ä½•åœæ­¢** | `cv2.waitKey('q')` | `stop()` è®¾ç½® Event ä¿¡å· |
| **å¦‚ä½•è·å–ç»“æœ** | `self.payload` å†…éƒ¨å˜é‡ | åŠ é”çš„å…±äº«çŠ¶æ€ `latest_result` |
| **å¦‚ä½•é˜²æ­¢å¹¶å‘å†²çª** | ä¸è€ƒè™‘ | ä½¿ç”¨ `threading.Lock()` |
| **å¦‚ä½•ä¼˜é›…é€€å‡º** | å¼ºåˆ¶ä¸­æ–­ | `Event.set()` + `thread.join()` |

### 3.2 æ ¸å¿ƒè®¾è®¡

```python
class StreamWorker:
    def __init__(self):
        # çº¿ç¨‹åŒæ­¥åŸè¯­
        self._lock = threading.Lock()         # ğŸ”’ ä¿æŠ¤å…±äº«çŠ¶æ€
        self._stop_event = threading.Event()  # ğŸš¦ ä¼˜é›…åœæ­¢ä¿¡å·
        self._thread = None                   # æ¨ç†çº¿ç¨‹å¼•ç”¨
        self._is_running = False              # è¿è¡ŒçŠ¶æ€æ ‡å¿—
        
        # å…±äº«çŠ¶æ€ (å¤šçº¿ç¨‹è®¿é—®ï¼Œå¿…é¡»åŠ é”)
        self.latest_result = {}               # æœ€æ–°æ£€æµ‹ç»“æœ
        self.latest_timestamp = 0.0           # ç»“æœæ—¶é—´æˆ³
        self.latest_preview_jpeg = None       # é¢„è§ˆå›¾ JPEG äºŒè¿›åˆ¶
        
        # å†…éƒ¨çŠ¶æ€ (ä»…åå°çº¿ç¨‹ä½¿ç”¨ï¼Œæ— éœ€åŠ é”)
        self._detector = None                 # ç®—æ³•å¼•æ“å®ä¾‹
```

### 3.3 start() æ–¹æ³•è®¾è®¡

```python
def start(self, source, algorithm, **kwargs):
    """å¯åŠ¨åå°æ¨ç†çº¿ç¨‹"""
    
    # âš ï¸ å…³é”®ç‚¹1: å…ˆåœæ­¢æ—§çº¿ç¨‹ï¼Œä¿è¯çŠ¶æ€ä¸€è‡´æ€§
    self.stop()
    
    with self._lock:
        # æ¸…ç©ºä¸Šä¸€è½®çŠ¶æ€
        self.latest_result = {}
        self.latest_preview_jpeg = None
        self._stop_event.clear()  # é‡ç½®åœæ­¢ä¿¡å·
        
        # åˆ›å»ºç®—æ³•å¼•æ“
        self._detector = self._create_detector(source, algorithm, **kwargs)
        self._is_running = True
        
        # å¯åŠ¨åå°çº¿ç¨‹
        self._thread = threading.Thread(
            target=self._inference_loop,
            daemon=True
        )
        self._thread.start()
```

### 3.4 stop() æ–¹æ³•è®¾è®¡

```python
def stop(self):
    """ä¼˜é›…åœæ­¢åå°çº¿ç¨‹"""
    
    with self._lock:
        if not self._is_running:
            return
        self._is_running = False
    
    # âš ï¸ å…³é”®ç‚¹2: ä½¿ç”¨ Event ä¿¡å·é€šçŸ¥çº¿ç¨‹é€€å‡ºï¼Œè€Œéå¼ºæ€
    self._stop_event.set()
    
    # âš ï¸ å…³é”®ç‚¹3: ç­‰å¾…çº¿ç¨‹çœŸæ­£é€€å‡ºï¼Œç¡®ä¿èµ„æºé‡Šæ”¾
    if self._thread and self._thread.is_alive():
        self._thread.join(timeout=3.0)
    
    self._thread = None
```

### 3.5 _inference_loop() ä¸ mainloop çš„å¯¹æ¯”

```python
def _inference_loop(self):
    """åå°çº¿ç¨‹ä¸»å¾ªç¯ (æ”¹é€ è‡ª mainloop)"""
    
    detector = self._detector
    detector.load_model(reload=True)
    cap = cv2.VideoCapture(str(detector.source))
    prev_gray = None
    frame_index = 0
    
    try:
        # â­• åŒºåˆ«1: å¾ªç¯æ¡ä»¶æ”¹ä¸ºæ£€æŸ¥ stop_event
        while not self._stop_event.is_set():
            ret, frame = cap.read()
            if not ret:
                break
            
            # ... (ä¸ mainloop ç›¸åŒçš„æ¨ç†é€»è¾‘) ...
            
            # â­• åŒºåˆ«2: åŠ é”å†™å…¥å…±äº«çŠ¶æ€ï¼Œè€Œé self.payload
            with self._lock:
                self.latest_result = frame_result.to_dict()
                self.latest_timestamp = time.time()
                # â­• åŒºåˆ«3: ç¼–ç ä¸º JPEGï¼Œè€Œé cv2.imshow()
                self.latest_preview_jpeg = self._render_preview(frame, result)
            
            frame_index += 1
    
    finally:
        # âš ï¸ å…³é”®ç‚¹4: æ— è®ºå¦‚ä½•éƒ½è¦æ¸…ç†èµ„æº
        cap.release()
        with self._lock:
            self._is_running = False
```

### 3.6 çº¿ç¨‹å®‰å…¨æ³¨æ„äº‹é¡¹

| åœºæ™¯ | é”™è¯¯åšæ³• | æ­£ç¡®åšæ³• |
|------|---------|---------|
| è¯»å– `latest_result` | ç›´æ¥è¯»å– | `with self._lock: result = self.latest_result.copy()` |
| å†™å…¥ `latest_result` | ç›´æ¥èµ‹å€¼ | `with self._lock: self.latest_result = ...` |
| æ£€æŸ¥ `is_running` | ç›´æ¥è¯»å– `_is_running` | è°ƒç”¨ `is_running()` æ–¹æ³• (å†…éƒ¨åŠ é”) |
| åœæ­¢çº¿ç¨‹ | `thread.terminate()` | `stop_event.set()` + `thread.join()` |

---

## Step 4: FastAPI æ¥å£å±‚

**ç›®æ ‡**: å¯¹å¤–æš´éœ² WebSocket æ¥å£ï¼Œå¹¶å®ç°å…¨åŒå·¥ã€ä¸é—´æ–­çš„æ¶ˆæ¯æ”¶å‘ã€‚

### 4.1 é€šè®¯å“²å­¦ï¼šå¼‚æ­¥åŒå¾ªç¯ (Twin-Loop)

åœ¨ WebSocket å¤„ç†å™¨å†…éƒ¨ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰å†™æˆä¸€ä¸ªé•¿é•¿çš„é¡ºåºç¨‹åºï¼Œè€Œæ˜¯é‡‡ç”¨äº† **"å¼‚æ­¥åŒå¾ªç¯"** è®¾è®¡ã€‚è¿™æ˜¯ä¸ºäº†å®ç°ï¼š
- **ä¸é—´æ–­ç›‘å¬**ï¼šä¸ç®¡ç®—æ³•æ¨æµæœ‰å¤šå¿™ï¼Œå¿…é¡»èƒ½ç§’å›å®¢äººçš„ `stop` æŒ‡ä»¤ã€‚
- **å®æ—¶æ¨é€**ï¼šä¸ç®¡å¤„ç†æŒ‡ä»¤æœ‰å¤šæ…¢ï¼Œæœ€æ–°çš„ç”»é¢å’Œç»“æœå¿…é¡»èƒ½ç«‹åˆ»å‘ç»™å‰ç«¯ã€‚

#### ä»£ç é€»è¾‘ç¤ºæ„å›¾

```python
async def websocket_handler(websocket: WebSocket):
    # 1. å»ºç«‹é•¿è¿æ¥ç®¡é“
    await websocket.accept()
    
    # ã€å¾ªç¯ Aã€‘: ä¼ å£°ç­’ (push_loop)
    # èŒè´£ï¼šå½“ä¸€ä¸ªæ¬è¿å·¥ï¼Œç›¯ç€ StreamWorker çš„å…±äº«æŸœå­ï¼Œæœ‰æ–°ç»“æœå°±å¾€å¤–æ‰”ã€‚
    async def push_loop():
        while True:
            # æ‹¿åˆ°æœ€æ–°å¿«ç…§ï¼Œå‘ç»™å‰ç«¯
            await websocket.send_json(worker.latest_result)

    # ã€å¾ªç¯ Bã€‘: é¡ºé£è€³ (receive_loop)
    # èŒè´£ï¼šå½“ä¸€ä¸ªæ¥çº¿å‘˜ï¼Œè€³æœµè´´åœ¨ç®¡é“ä¸Šï¼Œæ­»ç­‰å®¢äººçš„æ§åˆ¶å‘½ä»¤ã€‚
    async def receive_loop():
        while True:
            msg = await websocket.receive_json()
            if msg == "start": worker.start(...)
            if msg == "stop":  worker.stop()

    # ã€å…³é”®ã€‘: ä¸€å¿ƒäºŒç”¨
    # ä½¿ç”¨ gather åŒæ—¶å¯åŠ¨è¿™ä¸¤ä¸ªå¾ªç¯ï¼Œå®ƒä»¬äº’ä¸å¹²æ‰°ï¼Œä½†å…±ç”¨ä¸€æ¡ç”Ÿå‘½çº¿ã€‚
    await asyncio.gather(push_loop(), receive_loop())
```

### 4.2 ä¸ºä»€ä¹ˆè¿™ä¸ªè®¾è®¡æ˜¯"äº§å“çº§"çš„ï¼Ÿ

| ç‰¹æ€§ | æ™®é€š Request/Response | WebSocket åŒå¾ªç¯ |
|------|-----------------------|-----------------|
| **è¿è´¯æ€§** | é—®ä¸€æ¬¡ç­”ä¸€æ¬¡ï¼Œæ•°æ®æ–­æ–­ç»­ç»­ | å»ºç«‹ä¸€æ¬¡è¿æ¥ï¼Œç»“æœå¦‚å–·æ³‰èˆ¬æ¶Œå‡º |
| **æ§åˆ¶åŠ›** | å‘å‡ºè¯·æ±‚ååªèƒ½ç­‰ï¼Œæ— æ³•ä¸­é€”åæ‚” | æ¨æµè¿‡ç¨‹ä¸­ï¼Œéšæ—¶å¯ä»¥å‘é€ `stop` åˆ‡æ–­ç”µæº |
| **å®æ—¶æ€§** | å­˜åœ¨ TCP æ¡æ‰‹å¼€é”€ | æ•°æ®â€œé›¶è·ç¦»â€ç›´è¾¾ï¼Œæ¯«ç§’çº§å»¶è¿Ÿ |

---

## æ€»ç»“: å¼€å‘è·¯å¾„

```
1. å†™ç®—æ³•å±‚ (IllegalParkingDetector)
   - parkingdetect(): Stage 1 åœè½¦åˆ¤å®š
   - panduan(): Stage 2 åŒºåŸŸåˆ¤å®š
   â†“
2. å†™ mainloop è°ƒè¯•
   - æœ¬åœ°è·‘é€šï¼Œcv2.imshow() çœ‹æ•ˆæœ
   â†“
3. å†™ StreamWorker å°è£…
   - start()/stop() æ¥å£
   - çº¿ç¨‹å®‰å…¨çš„å…±äº«çŠ¶æ€
   - ä¼˜é›…åœæ­¢æœºåˆ¶
   â†“
4. å†™ FastAPI æ¥å£å±‚
   - WebSocket æ¥æ”¶æŒ‡ä»¤
   - WebSocket æ¨é€ç»“æœ
```

**æ ¸å¿ƒæ€æƒ³**: ç®—æ³•å±‚åªå…³å¿ƒ"æ€ä¹ˆç®—"ï¼ŒæœåŠ¡å±‚åªå…³å¿ƒ"æ€ä¹ˆè°ƒåº¦"ï¼Œæ¥å£å±‚åªå…³å¿ƒ"æ€ä¹ˆé€šä¿¡"ã€‚ä¸‰å±‚è§£è€¦ï¼Œå„å¸å…¶èŒã€‚
