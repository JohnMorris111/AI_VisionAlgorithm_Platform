<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIè¿åœæ£€æµ‹ - åœ¨çº¿æ¼”ç¤º</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
            min-height: 100vh;
        }

        h1 {
            margin-bottom: 20px;
            font-size: 24px;
        }

        h1 span {
            font-size: 14px;
            color: #a5b1c2;
        }

        .toolbar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 20px;
        }

        input,
        select {
            padding: 10px 15px;
            border: 1px solid #333;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
        }

        input {
            flex: 1;
            min-width: 200px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.1s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        .btn-start {
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: #fff;
        }

        .btn-stop {
            background: linear-gradient(135deg, #d63031, #e17055);
            color: #fff;
        }

        .status {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .status::before {
            content: '';
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .connected {
            background: rgba(46, 204, 113, 0.2);
        }

        .connected::before {
            background: #2ecc71;
        }

        .disconnected {
            background: rgba(231, 76, 60, 0.2);
        }

        .disconnected::before {
            background: #e74c3c;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
        }

        @media (max-width: 1000px) {
            .container {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
        }

        .panel h3 {
            margin: 0 0 15px 0;
            font-size: 16px;
            color: #a5b1c2;
        }

        #frame {
            width: 100%;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            min-height: 360px;
        }

        /* æˆªå›¾é¢æ¿ */
        .screenshot-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .screenshot-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 8px;
            text-align: center;
            font-size: 12px;
            color: #a5b1c2;
        }

        .screenshot-item img {
            width: 100%;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        .screenshot-placeholder {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            margin-bottom: 5px;
        }

        /* AI æŠ¥å‘Šé¢æ¿ */
        .report-panel {
            margin-top: 20px;
        }

        .report-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .report-item.ILLEGAL {
            border-left: 4px solid #ff4444;
        }

        .report-item.LEGAL {
            border-left: 4px solid #44ff44;
        }

        .report-item.REVIEW {
            border-left: 4px solid #ffcc00;
        }

        .verdict {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .verdict.ILLEGAL {
            color: #ff4444;
        }

        .verdict.LEGAL {
            color: #44ff44;
        }

        .verdict.REVIEW {
            color: #ffcc00;
        }

        .summary {
            font-size: 13px;
            line-height: 1.5;
            color: #ccc;
        }

        .confidence {
            font-size: 12px;
            color: #888;
            margin-top: 8px;
        }

        /* æ£€æµ‹ç»“æœ */
        .tracks-list {
            margin-top: 15px;
        }

        .track-item {
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .track-item.è¿è§„åœè½¦ {
            background: rgba(255, 68, 68, 0.15);
            border-color: #ff4444;
        }

        .track-item.åˆæ³•åœè½¦ {
            background: rgba(187, 68, 255, 0.15);
            border-color: #bb44ff;
        }

        .track-item.åœè½¦ {
            background: rgba(255, 204, 0, 0.15);
            border-color: #ffcc00;
        }

        .track-item.ç§»åŠ¨ {
            background: rgba(68, 255, 68, 0.15);
            border-color: #44ff44;
        }

        #result {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            max-height: 200px;
            overflow: auto;
            font-family: 'Menlo', monospace;
            font-size: 11px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
    </style>
</head>

<body>

    <h1>ğŸš— AIè¿åœæ£€æµ‹ <span>â€” åœ¨çº¿æ¼”ç¤º</span></h1>

    <div class="toolbar">
        <select id="algorithm">
            <option value="ws://127.0.0.1:8000/ws_roi">ROI ç®—æ³•</option>
            <option value="ws://127.0.0.1:8000/ws">èµç½šç®—æ³•</option>
        </select>
        <input id="source" value="ws://127.0.0.1:8011/stream" placeholder="è§†é¢‘æºåœ°å€">
        <button class="btn-start" onclick="start()">â–¶ï¸ å¼€å§‹æ£€æµ‹</button>
        <button class="btn-stop" onclick="stop()">â¹ï¸ åœæ­¢</button>
        <span id="status" class="status disconnected">æœªè¿æ¥</span>
    </div>

    <div class="container">
        <div style="display: flex; flex-direction: column; gap: 20px;">
            <div class="panel">
                <h3>ğŸ“¹ å®æ—¶ç”»é¢ï¼ˆå¸¦æ ‡æ³¨ï¼‰</h3>
                <img id="frame" alt="ç­‰å¾…è¿æ¥...">
            </div>

            <div class="panel">
                <h3>ğŸ“¸ è¿è§„æˆªå›¾</h3>
                <p style="font-size: 13px; color: #888;">æ£€æµ‹åˆ°è¿è§„åœè½¦åè‡ªåŠ¨æˆªå›¾ç•™å­˜</p>
                <div class="screenshot-grid" id="screenshots">
                    <div class="screenshot-item">
                        <div class="screenshot-placeholder">ğŸ–¼ï¸</div>
                        <div>å…¨æ™¯æˆªå›¾</div>
                    </div>
                    <div class="screenshot-item">
                        <div class="screenshot-placeholder">ğŸ”</div>
                        <div>ç›®æ ‡è£å‰ª</div>
                    </div>
                    <div class="screenshot-item">
                        <div class="screenshot-placeholder">ğŸ“</div>
                        <div>æ ‡æ³¨å›¾</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="sidebar">
            <div class="panel">
                <h3>ğŸ“Š æ£€æµ‹ç»“æœ</h3>
                <div id="tracks" class="tracks-list">ç­‰å¾…è¿æ¥...</div>
            </div>

            <div class="panel report-panel">
                <h3>ğŸ¤– AI è§†è§‰åˆ†æ</h3>
                <div id="reports">
                    <p style="font-size: 13px; color: #888;">
                        å½“æ£€æµ‹åˆ°è¿è§„åœè½¦åï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ç”Ÿæˆ AI è§†è§‰åˆ†ææŠ¥å‘Šï¼ŒåŒ…å«ï¼š
                    </p>
                    <ul style="font-size: 12px; color: #666; padding-left: 20px; margin: 10px 0;">
                        <li>åˆ¤å®šç»“è®ºï¼ˆè¿è§„/åˆæ³•/å¾…å¤æ ¸ï¼‰</li>
                        <li>ç½®ä¿¡åº¦è¯„åˆ†</li>
                        <li>è¯æ®å›¾ç‰‡åˆ†æ</li>
                        <li>AI æ€»ç»“è¯´æ˜</li>
                    </ul>
                    <p style="font-size: 12px; color: #888;">
                        æŠ¥å‘Šè‡ªåŠ¨ä¿å­˜è‡³ <code
                            style="background:rgba(255,255,255,0.1);padding:2px 6px;border-radius:4px;">result/</code>
                        ç›®å½•
                    </p>
                </div>
            </div>

            <div class="panel">
                <h3>ğŸ“„ åŸå§‹ JSON</h3>
                <pre id="result">ç­‰å¾…è¿æ¥...</pre>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // AIè¿åœæ£€æµ‹ - å‰ç«¯è°ƒç”¨ç¤ºä¾‹
        // å¤åˆ¶è¿™æ®µä»£ç å³å¯æ¥å…¥è¿åœæ£€æµ‹æœåŠ¡
        // ============================================================

        let ws = null;
        let expectingFrame = false;
        let violationCount = 0;

        /**
         * å¯åŠ¨æ£€æµ‹
         */
        function start() {
            const wsUrl = document.getElementById('algorithm').value;
            const source = document.getElementById('source').value;

            ws = new WebSocket(wsUrl);
            ws.binaryType = 'arraybuffer';

            ws.onopen = () => {
                setStatus('å·²è¿æ¥', true);
                ws.send(JSON.stringify({ type: 'start', source: source }));
            };

            ws.onmessage = (event) => {
                if (typeof event.data === 'string') {
                    const msg = JSON.parse(event.data);

                    if (msg.type === 'payload') {
                        renderPayload(msg.payload);
                        document.getElementById('result').textContent = JSON.stringify(msg.payload, null, 2);

                        // æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„è¿è§„äº‹ä»¶
                        checkViolations(msg.payload);
                    }
                    else if (msg.type === 'frame') {
                        expectingFrame = true;
                    }
                    else if (msg.type === 'started') {
                        setStatus(`æ£€æµ‹ä¸­ - ${msg.algorithm}`, true);
                    }
                    else if (msg.type === 'stopped') {
                        setStatus('å·²åœæ­¢', false);
                    }
                    else if (msg.type === 'error') {
                        setStatus(`é”™è¯¯: ${msg.error}`, false);
                    }
                }
                else if (event.data instanceof ArrayBuffer && expectingFrame) {
                    expectingFrame = false;
                    const blob = new Blob([event.data], { type: 'image/jpeg' });
                    document.getElementById('frame').src = URL.createObjectURL(blob);
                }
            };

            ws.onclose = () => setStatus('å·²æ–­å¼€', false);
            ws.onerror = () => setStatus('è¿æ¥é”™è¯¯', false);
        }

        /**
         * åœæ­¢æ£€æµ‹
         */
        function stop() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'stop' }));
            }
            if (ws) ws.close();
            ws = null;
            setStatus('å·²æ–­å¼€', false);
        }

        /**
         * æ£€æŸ¥è¿è§„äº‹ä»¶å¹¶æ›´æ–°æŠ¥å‘Šé¢æ¿
         */
        function checkViolations(payload) {
            if (!payload || !payload.tracks) return;

            const tracks = payload.tracks;
            for (const [id, track] of Object.entries(tracks)) {
                if (track.status === 'è¿è§„åœè½¦' && track.parked_frames > 30) {
                    // å‘ç°è¿è§„ï¼Œæ›´æ–°æŠ¥å‘Šé¢æ¿ç¤ºä¾‹
                    updateReportPanel(track);
                }
            }
        }

        /**
         * æ›´æ–° AI æŠ¥å‘Šé¢æ¿
         */
        function updateReportPanel(track) {
            const container = document.getElementById('reports');

            // åªæ˜¾ç¤ºæœ€æ–°çš„ä¸€æ¡ç¤ºä¾‹æŠ¥å‘Š
            container.innerHTML = `
        <div class="report-item REVIEW">
            <div class="verdict REVIEW">âš ï¸ å¾…äººå·¥å¤æ ¸</div>
            <div class="summary">
                è½¦è¾† #${track.track_id}ï¼ˆ${track.class_name}ï¼‰æ£€æµ‹åˆ°åœè½¦è¡Œä¸ºï¼Œ
                å·²åœç•™ ${track.parked_frames} å¸§ã€‚ç³»ç»Ÿåˆ¤å®šä¸º"${track.status}"ã€‚
                <br><br>
                å®Œæ•´ AI è§†è§‰åˆ†ææŠ¥å‘Šå·²ä¿å­˜è‡³ result/ ç›®å½•ï¼ŒåŒ…å«ï¼š
                <ul style="margin: 8px 0; padding-left: 20px;">
                    <li>å¤šè§’åº¦è¯æ®æˆªå›¾</li>
                    <li>è½¦è¾†ä½ç½®åˆ†æ</li>
                    <li>è¿è§„åŸå› è¯´æ˜</li>
                </ul>
            </div>
            <div class="confidence">ç½®ä¿¡åº¦: ${((track.conf || 0.8) * 100).toFixed(0)}%</div>
        </div>
    `;
        }

        // ============================================================
        // UI è¾…åŠ©å‡½æ•°
        // ============================================================

        function setStatus(text, connected) {
            const el = document.getElementById('status');
            el.textContent = text;
            el.className = 'status ' + (connected ? 'connected' : 'disconnected');
        }

        function renderPayload(payload) {
            const container = document.getElementById('tracks');
            if (!payload || !payload.tracks) {
                container.innerHTML = 'æš‚æ— æ£€æµ‹ç›®æ ‡';
                return;
            }

            const tracks = payload.tracks;
            const items = Object.values(tracks).map(t => `
        <div class="track-item ${t.status}">
            <strong>#${t.track_id}</strong> ${t.class_name || 'æœªçŸ¥'}
            <br>çŠ¶æ€: <strong>${t.status}</strong>
            <br>åœè½¦å¸§æ•°: ${t.parked_frames || 0}
            <br>ç½®ä¿¡åº¦: ${((t.conf || 0) * 100).toFixed(1)}%
        </div>
    `).join('');

            container.innerHTML = items || 'æš‚æ— æ£€æµ‹ç›®æ ‡';
        }
    </script>

</body>

</html>